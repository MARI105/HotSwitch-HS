local util = require("hotswitch-hs/lib/common/util")

local MainController = require("hotswitch-hs/lib/controller/MainController")
local SettingModel = require("hotswitch-hs/lib/model/SettingModel")

local mainController = MainController.new()
local function main()
    mainController:create()
    mainController.panel.baseCanvas:resetAutoGeneratedKeys()
end

local function openOrClose()
    if mainController.panel.isOpen then
        mainController:focusWindowForCancel()
        mainController:finish()
    else
        mainController.windows.previousWindow = hs.window.frontmostWindow()

        -- Enable hotkeys before refresh windows,
        -- because refreshing windows is slow and take time.
        local checkTime = util.checkTime.new()
        mainController:enable()
        -- checkTime:diff("enable") -- 60ms
        mainController.panel.baseCanvas:activateHammerspoonWindow()
        -- checkTime:diff("activate") -- 25ms
        mainController.windows:refreshOrderedWindows()
        -- checkTime:diff("refresh") -- 170ms
        mainController.panel:open()
        -- checkTime:diff("open") -- 170ms
        mainController:watchAppliationDeactivated()
        -- checkTime:diff("watch") -- 10ms
    end
end

local function clearSettings()
    SettingModel.new().clear()
end

local function enableDebug()
    util.enableDebug()
end

-- arg: autoGeneratedKeys = {"a", "b", "c"}
local function setAutoGeneratedKeys(specifiedAutoGeneratedKeys)
    mainController.panel.baseCanvas:setSpecifiedAutoGeneratedKeys(specifiedAutoGeneratedKeys)
    mainController.panel.baseCanvas:resetAutoGeneratedKeys()
end

main()

return {
    openOrClose = openOrClose,
    clearSettings = clearSettings,
    enableDebug = enableDebug,
    setAutoGeneratedKeys = setAutoGeneratedKeys,
}